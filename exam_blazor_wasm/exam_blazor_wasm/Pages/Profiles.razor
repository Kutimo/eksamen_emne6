@page "/profiles"
@inject IUserService UserService

<PageTitle>Profiles</PageTitle>

<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-primary mb-2">Random Profiles</h1>
        <p class="text-secondary">Discover people from around the world</p>
    </div>

    <ProfileControls OnCountChange="HandleCountChange" OnSearchChange="HandleSearchChange" OnRefresh="LoadUsers" />

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="bg-red-600 text-white p-6 rounded-xl mb-8">
            <p class="mb-4">@_errorMessage</p>
            <button class="bg-white text-red-600 px-4 py-2 rounded-lg font-semibold" @onclick="LoadUsers">
                Try Again
            </button>
        </div>
    }

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @if (_isLoading)
        {
            @for (int i = 0; i < _count; i++)
            {
                <UserCardSkeleton />
            }
        }
        else
        {
            @foreach (var user in FilteredUsers)
            {
                <UserCard @key="user.Id" User="user" OnClick="@OpenModal" />
            }
        }
    </div>
</div>

<UserDetailsModal User="@_selectedUser" IsOpen="@_isModalOpen" OnClose="@CloseModal" />

@code {
    private List<User> _users = [];
    private bool _isLoading = true;
    private int _count = 10;
    private string _searchText = string.Empty;
    private string? _errorMessage;
    private User? _selectedUser;
    private bool _isModalOpen;

    private IEnumerable<User> FilteredUsers => string.IsNullOrWhiteSpace(_searchText)
        ? _users
        : _users.Where(u =>
            u.FullName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.Gender.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.Country.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.City.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.State.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        _isLoading = true;
        _errorMessage = null;
        var result = await UserService.GetUsersAsync(_count);
        if (result.IsSuccess)
        {
            _users = result.Data ?? [];
        }
        else
        {
            _errorMessage = result.ErrorMessage;
        }
        _isLoading = false;
    }

    private async Task HandleCountChange(int count)
    {
        _count = count;
        await LoadUsers();
    }

    private void HandleSearchChange(string searchText)
    {
        _searchText = searchText;
    }

    private void OpenModal(User user)
    {
        _selectedUser = user;
        _isModalOpen = true;
    }

    private void CloseModal()
    {
        _isModalOpen = false;
        _selectedUser = null;
    }
}
