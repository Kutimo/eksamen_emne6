@page "/profiles"
@inject IUserService UserService

<ProfileControls OnCountChange="HandleCountChange" OnSearchChange="HandleSearchChange" OnRefresh="LoadUsers" />

@if (_isLoading)
{
    @for (int i = 0; i < _count; i++)
    {
        var index = i;
        <UserCardSkeleton @key="index" />
    }
}
else
{
    @foreach (var user in FilteredUsers)
    {
        <UserCard @key="user.Id" User="user" />
    }
}

@code {
    private List<User> _users = [];
    private bool _isLoading = true;
    private int _count = 10;
    private string _searchText = string.Empty;

    private IEnumerable<User> FilteredUsers => string.IsNullOrWhiteSpace(_searchText)
        ? _users
        : _users.Where(u => 
            u.FullName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.Gender.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.Country.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.City.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            u.State.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        _isLoading = true;
        _users = await UserService.GetUsersAsync(_count);
        _isLoading = false;
    }

    private async Task HandleCountChange(int count)
    {
        _count = count;
        await LoadUsers();
    }

    private void HandleSearchChange(string searchText)
    {
        _searchText = searchText;
    }
}